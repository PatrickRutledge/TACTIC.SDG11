#!/usr/bin/env -S node --loader ts-node/esm --no-warnings=ExperimentalWarning
/* eslint-disable n/shebang */

const performanceEnabled =
  process.env.STEPZEN_ENABLE_PERF !== undefined &&
  process.env.STEPZEN_ENABLE_PERF.toLocaleLowerCase() !== 'false'

if (performanceEnabled) {
  process.env.DEBUG = process.env.DEBUG
    ? `${process.env.DEBUG},oclif:non-oclif-perf`
    : 'oclif:non-oclif-perf'
}

const {execute, settings} = await import('@oclif/core')
settings.performanceEnabled = performanceEnabled

try {
  await execute({development: true, dir: import.meta.url})
} finally {
  const start = Date.now()
  const {analytics} = await import('../lib/shared/segment.js')
  await analytics?.closeAndFlush()

  // mimic oclif's Performance.mark() output
  //
  // Not using oclif's Performance API directly since at this point oclif is
  // already shut down
  if (settings.performanceEnabled) {
    const boldred = '\u001B[38;5;196;1m'
    const reset = '\u001B[0m'
    console.log(
      `  ${boldred}oclif:non-oclif-perf${reset}     segment.flush: ${
        Date.now() - start
      }ms`,
    )
  }
}
