// Copyright IBM Corp. 2020, 2025

import fsx from 'fs-extra'
import glob from 'glob'
import path from 'node:path'
import {flatMap} from 'lodash-es'
import {ALL_GRAPHQL_FILES} from './constants.js'

const WORKSPACE_FILE_PATTERNS = [
  '**/*.graphql',
  'stepzen.config.json',
  'config.yaml',
]

const IGNORED_PATTERNS = ['node_modules/**']

/**
 * Copy StepZen workspace content from one directory to another.
 *
 * Include only the files relevant to StepZen:
 *  - **â€‹/*.graphql
 *  - config.yaml
 *  - stepzen.config.json
 *
 * Exclude all other files.
 * Exclude special folders, e.g. node_modules
 */
export default (srcPath: string, dstPath: string) => {
  if (!fsx.existsSync(srcPath)) {
    throw new Error(`Cannot find source directory ${srcPath}`)
  }

  flatMap(WORKSPACE_FILE_PATTERNS, pattern =>
    glob.sync(pattern, {
      cwd: srcPath,
      ignore: IGNORED_PATTERNS,
    }),
  ).forEach(relativePath => {
    const srcFileFullPath = path.join(srcPath, relativePath)
    const dstFileFullPath = path.join(dstPath, relativePath)
    fsx.ensureDirSync(path.dirname(dstFileFullPath))
    fsx.copyFileSync(srcFileFullPath, dstFileFullPath)
  })
}

export const getAllGraphQLFiles = (srcPath: string) => {
  return glob
    .sync(ALL_GRAPHQL_FILES, {cwd: srcPath})
    .filter(file => file !== 'index.graphql')
}
