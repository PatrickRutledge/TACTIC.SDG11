// Copyright IBM Corp. 2020, 2025

import debug from 'debug'
import fs from 'node:fs'
import glob from 'glob'
import yaml from 'yaml'

// Validate the Configurationset file
export const validateConfigurationset = async (file: string | undefined) => {
  if (!file) {
    debug('stepzen:sdk')(
      `validateConfigurationset() expected 'file' to be a` +
        ` non-empty string but got ${file}`,
    )
    throw new Error('You must provide a file path')
  }

  if (!fs.existsSync(file)) {
    debug('stepzen:sdk')(`validateConfigurationset() expected ${file} to exist`)
    throw new Error('The file does not exist')
  }

  const content = fs.readFileSync(file, 'utf8')

  // Ensure the file is valid YAML
  try {
    yaml.parse(content)
  } catch (error) {
    debug('stepzen:sdk')(
      `validateConfigurationset() expected ${file} to parse as YAML,` +
        ` but got an error ${error}`,
    )
    throw new Error('The file is not valid YAML')
  }
}

// Validate the Schema directory
export const validateSchema = async (directory: string | undefined) => {
  if (!directory) {
    throw new Error('You must provide a directory path')
  }

  if (!fs.existsSync(directory)) {
    throw new Error('The directory does not exist')
  }

  // Ensure there's a root `index.graphql` file
  const allSchemaFiles = glob.sync('index.graphql', {cwd: directory})
  if (allSchemaFiles.length === 0) {
    throw new Error('Schemas must include an `index.graphql` file')
  }
}
