// Copyright IBM Corp. 2020, 2025

import {Agent as HttpAgent} from 'node:http'
import {Agent as HttpsAgent} from 'node:https'
import fetchCJSModule from 'node-fetch'
import {RequestInfo, RequestInit, Response} from 'node-fetch'

// workaround for https://github.com/steprz/stepzen-cli/issues/934
const httpAgent = new HttpAgent({
  keepAlive: true,
  scheduling: 'lifo',
  timeout: 5000,
})

const httpsAgent = new HttpsAgent({
  keepAlive: true,
  scheduling: 'lifo',
  timeout: 5000,
})

const fetch = async (
  url: RequestInfo,
  init?: RequestInit,
): Promise<Response> => {
  let urlstr
  if (typeof url === 'string') {
    urlstr = url
  } else if ('href' in url) {
    urlstr = url.href
  } else {
    urlstr = url.url
  }

  return fetchCJSModule.default(url, {
    agent: urlstr.startsWith('https:') ? httpsAgent : httpAgent,
    ...init,
  })
}

export default fetch
