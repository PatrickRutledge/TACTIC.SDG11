// Copyright IBM Corp. 2020, 2025

import os from 'node:os'
import * as isWsl from 'is-wsl'
import {createRequire} from 'node:module'
import {
  SDKConfiguration,
  StepZenAccount,
  ZenCtlRequestHeaders,
} from './types.js'

const {version} = createRequire(import.meta.url)('../../package.json')

// mimics the logic from @oclif/config
// https://github.com/oclif/core/blob/d7067d13c7d80c9e0064455c27ac1ebb6ee53fd2/src/config/config.ts#L128
const arch = os.arch() === 'ia32' ? 'x86' : (os.arch() as any)
const platform = isWsl ? 'wsl' : (os.platform() as any)

export const getUserAgent = (sdkConfig: SDKConfiguration): string => {
  return `${sdkConfig.appName} stepzen-sdk/${version} (${platform}; ${arch}; node-${process.version})`
}

export const getRequestHeaders = (
  account: StepZenAccount,
  sdkConfig: SDKConfiguration,
): ZenCtlRequestHeaders => {
  return {
    authorization: `Apikey ${account.adminkey}`,
    'stepzen-cli-version': version,
    'user-agent': getUserAgent(sdkConfig),
  }
}
